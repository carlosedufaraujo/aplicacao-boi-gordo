<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Integra√ß√£o Cash Flow em Relat√≥rios</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #666;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #0b7dda;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e68900;
        }
        
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .data-display {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .summary-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .summary-card.revenue .value {
            color: #4CAF50;
        }
        
        .summary-card.expense .value {
            color: #f44336;
        }
        
        .movement-list {
            margin: 15px 0;
        }
        
        .movement-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .movement-item.revenue {
            border-left: 4px solid #4CAF50;
        }
        
        .movement-item.expense {
            border-left: 4px solid #f44336;
        }
        
        .movement-info {
            flex: 1;
        }
        
        .movement-amount {
            font-weight: bold;
            font-size: 18px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Teste de Integra√ß√£o - Cash Flow em Relat√≥rios</h1>
        
        <!-- Se√ß√£o de Cria√ß√£o de Movimenta√ß√µes -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ Criar Movimenta√ß√µes de Teste</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="createSampleMovements()">
                    ‚ûï Criar Movimenta√ß√µes de Exemplo
                </button>
                <button class="btn-warning" onclick="createScheduledMovements()">
                    üìÖ Criar Movimenta√ß√µes Programadas
                </button>
            </div>
            <div id="creation-status"></div>
        </div>
        
        <!-- Se√ß√£o de Busca de Dados -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ Buscar Dados do Cash Flow</h2>
            <div class="button-group">
                <button class="btn-secondary" onclick="fetchCashFlowData()">
                    üîç Buscar Todas as Movimenta√ß√µes
                </button>
                <button class="btn-secondary" onclick="fetchUpcomingMovements()">
                    üìÜ Buscar Movimenta√ß√µes Pr√≥ximas (30 dias)
                </button>
            </div>
            <div id="fetch-status"></div>
            <div id="data-display" class="data-display" style="display: none;"></div>
        </div>
        
        <!-- Resumo do Cash Flow -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ Resumo do Cash Flow</h2>
            <div id="summary-grid" class="summary-grid"></div>
        </div>
        
        <!-- Movimenta√ß√µes Programadas -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ Movimenta√ß√µes Programadas (Pr√≥ximos 30 dias)</h2>
            <div id="upcoming-movements" class="movement-list"></div>
        </div>
        
        <!-- Teste de Integra√ß√£o com Relat√≥rios -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ Teste de Integra√ß√£o com P√°gina de Relat√≥rios</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="testReportsIntegration()">
                    üß™ Testar Integra√ß√£o Completa
                </button>
                <button class="btn-secondary" onclick="window.location.href='http://localhost:5173/reports'">
                    üìä Abrir P√°gina de Relat√≥rios
                </button>
            </div>
            <div id="integration-status"></div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:3001/api/v1';
        
        // Fun√ß√£o auxiliar para obter token
        function getAuthToken() {
            return localStorage.getItem('authToken') || localStorage.getItem('token');
        }
        
        // Criar movimenta√ß√µes de exemplo
        async function createSampleMovements() {
            const status = document.getElementById('creation-status');
            const token = getAuthToken();
            
            if (!token) {
                status.className = 'status error';
                status.innerHTML = '‚ùå Token n√£o encontrado. Fa√ßa login primeiro.';
                return;
            }
            
            status.className = 'status info';
            status.innerHTML = 'Criando movimenta√ß√µes de exemplo... <span class="loading"></span>';
            
            const movements = [
                {
                    description: 'Venda de Gado - Lote #001',
                    type: 'REVENUE',
                    amount: 45000,
                    categoryId: 'cattle_sales',
                    accountId: localStorage.getItem('defaultAccountId') || '1',
                    dueDate: new Date().toISOString(),
                    status: 'COMPLETED'
                },
                {
                    description: 'Compra de Ra√ß√£o - Fornecedor ABC',
                    type: 'EXPENSE',
                    amount: 8500,
                    categoryId: 'feed',
                    accountId: localStorage.getItem('defaultAccountId') || '1',
                    dueDate: new Date().toISOString(),
                    status: 'COMPLETED'
                },
                {
                    description: 'Medicamentos Veterin√°rios',
                    type: 'EXPENSE',
                    amount: 3200,
                    categoryId: 'veterinary',
                    accountId: localStorage.getItem('defaultAccountId') || '1',
                    dueDate: new Date().toISOString(),
                    status: 'COMPLETED'
                }
            ];
            
            let created = 0;
            let errors = 0;
            
            for (const movement of movements) {
                try {
                    const response = await fetch(`${API_URL}/cash-flow`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(movement)
                    });
                    
                    if (response.ok) {
                        created++;
                    } else {
                        errors++;
                        console.error('Erro ao criar movimenta√ß√£o:', await response.text());
                    }
                } catch (error) {
                    errors++;
                    console.error('Erro:', error);
                }
            }
            
            if (errors === 0) {
                status.className = 'status success';
                status.innerHTML = `‚úÖ ${created} movimenta√ß√µes criadas com sucesso!`;
            } else {
                status.className = 'status error';
                status.innerHTML = `‚ö†Ô∏è ${created} criadas, ${errors} erros`;
            }
        }
        
        // Criar movimenta√ß√µes programadas
        async function createScheduledMovements() {
            const status = document.getElementById('creation-status');
            const token = getAuthToken();
            
            if (!token) {
                status.className = 'status error';
                status.innerHTML = '‚ùå Token n√£o encontrado. Fa√ßa login primeiro.';
                return;
            }
            
            status.className = 'status info';
            status.innerHTML = 'Criando movimenta√ß√µes programadas... <span class="loading"></span>';
            
            const today = new Date();
            const movements = [
                {
                    description: 'Pagamento - Fornecedor de Ra√ß√£o (Vence em 5 dias)',
                    type: 'EXPENSE',
                    amount: 12000,
                    categoryId: 'feed',
                    accountId: localStorage.getItem('defaultAccountId') || '1',
                    dueDate: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'PENDING'
                },
                {
                    description: 'Recebimento - Venda Lote #002 (Vence em 10 dias)',
                    type: 'REVENUE',
                    amount: 65000,
                    categoryId: 'cattle_sales',
                    accountId: localStorage.getItem('defaultAccountId') || '1',
                    dueDate: new Date(today.getTime() + 10 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'PENDING'
                },
                {
                    description: 'Sal√°rios e Encargos (Vence em 15 dias)',
                    type: 'EXPENSE',
                    amount: 18500,
                    categoryId: 'salary',
                    accountId: localStorage.getItem('defaultAccountId') || '1',
                    dueDate: new Date(today.getTime() + 15 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'PENDING'
                },
                {
                    description: 'Manuten√ß√£o de Equipamentos (Vence em 20 dias)',
                    type: 'EXPENSE',
                    amount: 4500,
                    categoryId: 'maintenance',
                    accountId: localStorage.getItem('defaultAccountId') || '1',
                    dueDate: new Date(today.getTime() + 20 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'PENDING'
                }
            ];
            
            let created = 0;
            let errors = 0;
            
            for (const movement of movements) {
                try {
                    const response = await fetch(`${API_URL}/cash-flow`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(movement)
                    });
                    
                    if (response.ok) {
                        created++;
                    } else {
                        errors++;
                        console.error('Erro ao criar movimenta√ß√£o programada:', await response.text());
                    }
                } catch (error) {
                    errors++;
                    console.error('Erro:', error);
                }
            }
            
            if (errors === 0) {
                status.className = 'status success';
                status.innerHTML = `‚úÖ ${created} movimenta√ß√µes programadas criadas com sucesso!`;
            } else {
                status.className = 'status error';
                status.innerHTML = `‚ö†Ô∏è ${created} criadas, ${errors} erros`;
            }
        }
        
        // Buscar dados do Cash Flow
        async function fetchCashFlowData() {
            const status = document.getElementById('fetch-status');
            const display = document.getElementById('data-display');
            const token = getAuthToken();
            
            if (!token) {
                status.className = 'status error';
                status.innerHTML = '‚ùå Token n√£o encontrado. Fa√ßa login primeiro.';
                return;
            }
            
            status.className = 'status info';
            status.innerHTML = 'Buscando dados do Cash Flow... <span class="loading"></span>';
            
            try {
                const response = await fetch(`${API_URL}/cash-flow`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    status.className = 'status success';
                    status.innerHTML = `‚úÖ ${data.data?.items?.length || 0} movimenta√ß√µes encontradas`;
                    
                    display.style.display = 'block';
                    display.textContent = JSON.stringify(data.data, null, 2);
                    
                    // Atualizar resumo
                    updateSummary(data.data?.items || []);
                } else {
                    status.className = 'status error';
                    status.innerHTML = `‚ùå Erro: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }
        
        // Buscar movimenta√ß√µes pr√≥ximas
        async function fetchUpcomingMovements() {
            const status = document.getElementById('fetch-status');
            const display = document.getElementById('data-display');
            const token = getAuthToken();
            
            if (!token) {
                status.className = 'status error';
                status.innerHTML = '‚ùå Token n√£o encontrado. Fa√ßa login primeiro.';
                return;
            }
            
            status.className = 'status info';
            status.innerHTML = 'Buscando movimenta√ß√µes programadas... <span class="loading"></span>';
            
            try {
                const response = await fetch(`${API_URL}/cash-flow`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const items = data.data?.items || [];
                    
                    // Filtrar movimenta√ß√µes dos pr√≥ximos 30 dias
                    const today = new Date();
                    const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                    
                    const upcoming = items.filter(item => {
                        const dueDate = new Date(item.dueDate);
                        return item.status === 'PENDING' && 
                               dueDate > today && 
                               dueDate <= thirtyDaysFromNow;
                    });
                    
                    status.className = 'status success';
                    status.innerHTML = `‚úÖ ${upcoming.length} movimenta√ß√µes programadas para os pr√≥ximos 30 dias`;
                    
                    display.style.display = 'block';
                    display.textContent = JSON.stringify(upcoming, null, 2);
                    
                    // Atualizar lista de movimenta√ß√µes programadas
                    updateUpcomingMovements(upcoming);
                } else {
                    status.className = 'status error';
                    status.innerHTML = `‚ùå Erro: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }
        
        // Atualizar resumo
        function updateSummary(items) {
            const grid = document.getElementById('summary-grid');
            
            const totalRevenue = items
                .filter(i => i.type === 'REVENUE')
                .reduce((sum, i) => sum + i.amount, 0);
            
            const totalExpense = items
                .filter(i => i.type === 'EXPENSE')
                .reduce((sum, i) => sum + i.amount, 0);
            
            const pendingRevenue = items
                .filter(i => i.type === 'REVENUE' && i.status === 'PENDING')
                .reduce((sum, i) => sum + i.amount, 0);
            
            const pendingExpense = items
                .filter(i => i.type === 'EXPENSE' && i.status === 'PENDING')
                .reduce((sum, i) => sum + i.amount, 0);
            
            const balance = totalRevenue - totalExpense;
            
            grid.innerHTML = `
                <div class="summary-card revenue">
                    <h3>Total de Receitas</h3>
                    <div class="value">R$ ${totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                </div>
                <div class="summary-card expense">
                    <h3>Total de Despesas</h3>
                    <div class="value">R$ ${totalExpense.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                </div>
                <div class="summary-card">
                    <h3>Saldo</h3>
                    <div class="value" style="color: ${balance >= 0 ? '#4CAF50' : '#f44336'}">
                        R$ ${balance.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                    </div>
                </div>
                <div class="summary-card">
                    <h3>Receitas Pendentes</h3>
                    <div class="value">R$ ${pendingRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                </div>
                <div class="summary-card">
                    <h3>Despesas Pendentes</h3>
                    <div class="value">R$ ${pendingExpense.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                </div>
                <div class="summary-card">
                    <h3>Total de Movimenta√ß√µes</h3>
                    <div class="value">${items.length}</div>
                </div>
            `;
        }
        
        // Atualizar lista de movimenta√ß√µes programadas
        function updateUpcomingMovements(items) {
            const container = document.getElementById('upcoming-movements');
            
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #666;">Nenhuma movimenta√ß√£o programada para os pr√≥ximos 30 dias.</p>';
                return;
            }
            
            // Ordenar por data de vencimento
            items.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            container.innerHTML = items.map(item => {
                const dueDate = new Date(item.dueDate);
                const daysUntilDue = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="movement-item ${item.type.toLowerCase()}">
                        <div class="movement-info">
                            <strong>${item.description}</strong><br>
                            <small>Vence em ${daysUntilDue} dias (${dueDate.toLocaleDateString('pt-BR')})</small>
                        </div>
                        <div class="movement-amount" style="color: ${item.type === 'REVENUE' ? '#4CAF50' : '#f44336'}">
                            ${item.type === 'REVENUE' ? '+' : '-'} R$ ${item.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Testar integra√ß√£o com relat√≥rios
        async function testReportsIntegration() {
            const status = document.getElementById('integration-status');
            const token = getAuthToken();
            
            if (!token) {
                status.className = 'status error';
                status.innerHTML = '‚ùå Token n√£o encontrado. Fa√ßa login primeiro.';
                return;
            }
            
            status.className = 'status info';
            status.innerHTML = 'Testando integra√ß√£o com a p√°gina de relat√≥rios... <span class="loading"></span>';
            
            try {
                // Buscar dados do Cash Flow
                const cashFlowResponse = await fetch(`${API_URL}/cash-flow`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Buscar categorias
                const categoriesResponse = await fetch(`${API_URL}/categories`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Buscar contas
                const accountsResponse = await fetch(`${API_URL}/payer-accounts`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const results = [];
                
                if (cashFlowResponse.ok) {
                    const data = await cashFlowResponse.json();
                    results.push(`‚úÖ Cash Flow: ${data.data?.items?.length || 0} movimenta√ß√µes`);
                } else {
                    results.push(`‚ùå Cash Flow: Erro ${cashFlowResponse.status}`);
                }
                
                if (categoriesResponse.ok) {
                    const data = await categoriesResponse.json();
                    results.push(`‚úÖ Categorias: ${data.data?.items?.length || 0} categorias`);
                } else {
                    results.push(`‚ùå Categorias: Erro ${categoriesResponse.status}`);
                }
                
                if (accountsResponse.ok) {
                    const data = await accountsResponse.json();
                    results.push(`‚úÖ Contas: ${data.data?.items?.length || 0} contas`);
                } else {
                    results.push(`‚ùå Contas: Erro ${accountsResponse.status}`);
                }
                
                status.className = 'status success';
                status.innerHTML = `
                    <strong>Resultado da Integra√ß√£o:</strong><br>
                    ${results.join('<br>')}
                    <br><br>
                    <strong>Pr√≥ximo passo:</strong> Abra a p√°gina de relat√≥rios para verificar se os dados est√£o sendo exibidos corretamente.
                `;
                
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `‚ùå Erro na integra√ß√£o: ${error.message}`;
            }
        }
        
        // Verificar token ao carregar
        window.onload = () => {
            const token = getAuthToken();
            if (!token) {
                alert('Token n√£o encontrado! Fa√ßa login primeiro usando o quick-login.html');
            } else {
                console.log('‚úÖ Token encontrado, pronto para testes');
            }
        };
    </script>
</body>
</html>