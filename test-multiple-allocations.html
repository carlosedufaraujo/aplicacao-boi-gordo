<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste - Lotes com M√∫ltiplas Aloca√ß√µes</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .lot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
        .lot-title { font-size: 20px; font-weight: bold; color: #333; }
        .lot-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-item { padding: 10px; background: #f9f9f9; border-radius: 5px; }
        .info-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .info-value { font-size: 18px; font-weight: bold; color: #333; margin-top: 5px; }
        .allocations { margin-top: 20px; }
        .allocation-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f0f8ff; border-left: 4px solid #2196f3; margin-bottom: 10px; border-radius: 4px; }
        .pen-info { flex: 1; }
        .pen-number { font-size: 16px; font-weight: bold; color: #1976d2; }
        .pen-details { font-size: 14px; color: #666; margin-top: 5px; }
        .allocation-stats { text-align: right; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .stat-label { font-size: 12px; color: #666; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge.multiple { background: #fff3e0; color: #e65100; }
        .badge.single { background: #e8f5e9; color: #2e7d32; }
        .summary { background: #fff9c4; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .summary h3 { margin: 0 0 10px 0; color: #f57c00; }
        .progress { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background: #2196f3; transition: width 0.3s; }
        .warning { background: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêÇ An√°lise de Lotes com M√∫ltiplas Aloca√ß√µes</h1>
        
        <div id="summary" class="card"></div>
        <div id="lotsContainer"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/v1';
        
        async function loadMultipleAllocations() {
            const summaryDiv = document.getElementById('summary');
            const containerDiv = document.getElementById('lotsContainer');
            
            summaryDiv.innerHTML = '<div style="text-align: center; color: #666;">Carregando dados...</div>';
            containerDiv.innerHTML = '';
            
            try {
                // Buscar dados dos lotes e currais
                const [lotsRes, pensRes] = await Promise.all([
                    fetch(`${API_BASE}/cattle-purchases`),
                    fetch(`${API_BASE}/pens`)
                ]);
                
                const lotsData = await lotsRes.json();
                const pensData = await pensRes.json();
                
                const allLots = lotsData.items || [];
                const allPens = pensData.data?.items || [];
                
                // Filtrar lotes com aloca√ß√µes
                const lotsWithAllocations = allLots.filter(lot => 
                    lot.penAllocations && lot.penAllocations.length > 0
                );
                
                // Separar lotes com m√∫ltiplas aloca√ß√µes
                const multipleAllocations = lotsWithAllocations.filter(lot => 
                    lot.penAllocations.length > 1
                );
                
                const singleAllocations = lotsWithAllocations.filter(lot => 
                    lot.penAllocations.length === 1
                );
                
                // Exibir resumo
                summaryDiv.innerHTML = `
                    <h2>üìä Resumo Geral</h2>
                    <div class="lot-info">
                        <div class="info-item">
                            <div class="info-label">Total de Lotes</div>
                            <div class="info-value">${allLots.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Lotes Alocados</div>
                            <div class="info-value">${lotsWithAllocations.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">M√∫ltiplas Aloca√ß√µes</div>
                            <div class="info-value">${multipleAllocations.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Aloca√ß√£o √önica</div>
                            <div class="info-value">${singleAllocations.length}</div>
                        </div>
                    </div>
                    ${multipleAllocations.length > 0 ? `
                        <div class="summary">
                            <h3>‚ö†Ô∏è Aten√ß√£o: ${multipleAllocations.length} lotes est√£o divididos em m√∫ltiplos currais</h3>
                            <p>Isso pode impactar o manejo e controle dos animais.</p>
                        </div>
                    ` : ''}
                `;
                
                // Exibir lotes com m√∫ltiplas aloca√ß√µes
                if (multipleAllocations.length > 0) {
                    containerDiv.innerHTML += '<h2 style="margin: 30px 0 20px;">üîÄ Lotes com M√∫ltiplas Aloca√ß√µes</h2>';
                    
                    multipleAllocations.forEach(lot => {
                        const totalAnimals = lot.currentQuantity;
                        const allocationsHtml = lot.penAllocations.map(alloc => {
                            const percentage = ((alloc.quantity / totalAnimals) * 100).toFixed(1);
                            const pen = allPens.find(p => p.id === alloc.penId);
                            const occupancyRate = pen ? ((alloc.quantity / pen.capacity) * 100).toFixed(1) : 0;
                            
                            return `
                                <div class="allocation-card">
                                    <div class="pen-info">
                                        <div class="pen-number">üè† Curral ${alloc.pen?.penNumber || 'N/A'}</div>
                                        <div class="pen-details">
                                            Capacidade: ${pen?.capacity || 'N/A'} | 
                                            Localiza√ß√£o: ${pen?.location || 'N/A'}
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar" style="width: ${occupancyRate}%"></div>
                                        </div>
                                    </div>
                                    <div class="allocation-stats">
                                        <div class="stat-value">${alloc.quantity}</div>
                                        <div class="stat-label">animais (${percentage}% do lote)</div>
                                        <div style="margin-top: 5px; color: #666; font-size: 12px;">
                                            ${occupancyRate}% do curral
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        containerDiv.innerHTML += `
                            <div class="card">
                                <div class="lot-header">
                                    <div class="lot-title">
                                        ${lot.lotCode}
                                        <span class="badge multiple">${lot.penAllocations.length} currais</span>
                                    </div>
                                    <div>
                                        <strong>${totalAnimals}</strong> animais total
                                    </div>
                                </div>
                                <div class="lot-info">
                                    <div class="info-item">
                                        <div class="info-label">Fornecedor</div>
                                        <div class="info-value" style="font-size: 14px;">${lot.vendor?.name || 'N/A'}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Localiza√ß√£o</div>
                                        <div class="info-value" style="font-size: 14px;">${lot.city || 'N/A'} - ${lot.state || 'N/A'}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Tipo</div>
                                        <div class="info-value" style="font-size: 14px;">${lot.animalType || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="allocations">
                                    <h3>Distribui√ß√£o nos Currais:</h3>
                                    ${allocationsHtml}
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Verificar superlota√ß√£o
                const overloadedPens = allPens.filter(pen => {
                    const totalInPen = lotsWithAllocations.reduce((sum, lot) => {
                        const allocsInThisPen = lot.penAllocations.filter(a => a.penId === pen.id);
                        return sum + allocsInThisPen.reduce((s, a) => s + a.quantity, 0);
                    }, 0);
                    return totalInPen > pen.capacity;
                });
                
                if (overloadedPens.length > 0) {
                    containerDiv.innerHTML += `
                        <div class="card">
                            <div class="warning">
                                <h3>‚ö†Ô∏è Currais Superlotados Detectados!</h3>
                                ${overloadedPens.map(pen => {
                                    const totalInPen = lotsWithAllocations.reduce((sum, lot) => {
                                        const allocsInThisPen = lot.penAllocations.filter(a => a.penId === pen.id);
                                        return sum + allocsInThisPen.reduce((s, a) => s + a.quantity, 0);
                                    }, 0);
                                    return `<div>Curral ${pen.penNumber}: ${totalInPen}/${pen.capacity} animais (${((totalInPen/pen.capacity)*100).toFixed(0)}% de ocupa√ß√£o)</div>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                summaryDiv.innerHTML = `<div class="warning">Erro ao carregar dados: ${error.message}</div>`;
            }
        }
        
        // Carregar ao abrir a p√°gina
        window.onload = () => loadMultipleAllocations();
    </script>
</body>
</html>