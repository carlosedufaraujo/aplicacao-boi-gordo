<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste - P√°gina de Lotes</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; }
        .test-section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        .lot-card { background: white; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .pen-allocation { background: #e8f5e9; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; }
        .status.confined { background: #4caf50; }
        .status.active { background: #2196f3; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .metric-card { background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .metric-value { font-size: 24px; font-weight: bold; color: #2196f3; }
        .error { color: red; padding: 10px; background: #ffebee; border-radius: 5px; }
        .success { color: green; padding: 10px; background: #e8f5e9; border-radius: 5px; }
        button { padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976d2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêÇ Teste - P√°gina de Lotes Alocados</h1>
        
        <div class="test-section">
            <h2>1. Verificar Compras Alocadas</h2>
            <button onclick="fetchAllocatedPurchases()">Buscar Lotes Alocados</button>
            <div id="allocatedResult"></div>
        </div>

        <div class="test-section">
            <h2>2. M√©tricas dos Lotes</h2>
            <button onclick="fetchMetrics()">Calcular M√©tricas</button>
            <div id="metricsResult"></div>
        </div>

        <div class="test-section">
            <h2>3. Mapa de Currais</h2>
            <button onclick="fetchPenMap()">Ver Ocupa√ß√£o dos Currais</button>
            <div id="penMapResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/v1';

        async function fetchAllocatedPurchases() {
            const resultDiv = document.getElementById('allocatedResult');
            resultDiv.innerHTML = 'Carregando...';
            
            try {
                const response = await fetch(`${API_BASE}/cattle-purchases`);
                const data = await response.json();
                
                // Filtrar apenas compras alocadas (stage: confined ou active)
                const allocatedPurchases = data.items.filter(p => 
                    p.stage === 'confined' || p.stage === 'active'
                );
                
                if (allocatedPurchases.length === 0) {
                    resultDiv.innerHTML = '<div class="error">Nenhuma compra alocada encontrada</div>';
                    return;
                }
                
                let html = `
                    <div class="success">‚úÖ ${allocatedPurchases.length} lotes alocados encontrados</div>
                    <div class="metrics">
                        <div class="metric-card">
                            <div>Total de Lotes</div>
                            <div class="metric-value">${allocatedPurchases.length}</div>
                        </div>
                        <div class="metric-card">
                            <div>Total de Animais</div>
                            <div class="metric-value">${allocatedPurchases.reduce((sum, p) => sum + p.currentQuantity, 0)}</div>
                        </div>
                    </div>
                `;
                
                allocatedPurchases.forEach(purchase => {
                    const penInfo = purchase.penAllocations && purchase.penAllocations[0] 
                        ? purchase.penAllocations[0] 
                        : null;
                    
                    html += `
                        <div class="lot-card">
                            <h3>üì¶ ${purchase.lotCode} <span class="status ${purchase.stage}">${purchase.stage}</span></h3>
                            <p><strong>Fornecedor:</strong> ${purchase.vendor?.name || 'N/A'}</p>
                            <p><strong>Localiza√ß√£o:</strong> ${purchase.city || 'N/A'} - ${purchase.state || 'N/A'}</p>
                            <p><strong>Quantidade:</strong> ${purchase.currentQuantity} animais</p>
                            <p><strong>Peso m√©dio:</strong> ${(purchase.averageWeight || 0).toFixed(2)} kg</p>
                            
                            ${penInfo ? `
                                <div class="pen-allocation">
                                    <strong>üè† Curral Alocado:</strong> ${penInfo.pen?.penNumber || 'N/A'}<br>
                                    <strong>Quantidade no curral:</strong> ${penInfo.quantity} animais<br>
                                    <strong>% do lote:</strong> ${penInfo.percentageOfLot?.toFixed(1)}%<br>
                                    <strong>% do curral:</strong> ${penInfo.percentageOfPen?.toFixed(1)}%
                                </div>
                            ` : '<div class="error">‚ö†Ô∏è Sem aloca√ß√£o de curral</div>'}
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        async function fetchMetrics() {
            const resultDiv = document.getElementById('metricsResult');
            resultDiv.innerHTML = 'Calculando m√©tricas...';
            
            try {
                const response = await fetch(`${API_BASE}/cattle-purchases`);
                const data = await response.json();
                
                const allocatedPurchases = data.items.filter(p => 
                    p.stage === 'confined' || p.stage === 'active'
                );
                
                const totalAnimals = allocatedPurchases.reduce((sum, p) => sum + p.currentQuantity, 0);
                const totalInvestment = allocatedPurchases.reduce((sum, p) => sum + p.totalCost, 0);
                const totalDeaths = allocatedPurchases.reduce((sum, p) => sum + (p.deathCount || 0), 0);
                const avgWeight = allocatedPurchases.length > 0 
                    ? allocatedPurchases.reduce((sum, p) => sum + (p.averageWeight || 0), 0) / allocatedPurchases.length
                    : 0;
                
                resultDiv.innerHTML = `
                    <div class="metrics">
                        <div class="metric-card">
                            <div>üìä Total de Lotes</div>
                            <div class="metric-value">${allocatedPurchases.length}</div>
                        </div>
                        <div class="metric-card">
                            <div>üêÇ Total de Animais</div>
                            <div class="metric-value">${totalAnimals}</div>
                        </div>
                        <div class="metric-card">
                            <div>üí∞ Investimento Total</div>
                            <div class="metric-value">R$ ${totalInvestment.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        </div>
                        <div class="metric-card">
                            <div>‚öñÔ∏è Peso M√©dio</div>
                            <div class="metric-value">${avgWeight.toFixed(2)} kg</div>
                        </div>
                        <div class="metric-card">
                            <div>üíÄ Total de Mortes</div>
                            <div class="metric-value">${totalDeaths}</div>
                        </div>
                        <div class="metric-card">
                            <div>üìà Taxa de Mortalidade</div>
                            <div class="metric-value">${totalDeaths > 0 ? ((totalDeaths / (totalAnimals + totalDeaths)) * 100).toFixed(2) : 0}%</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        async function fetchPenMap() {
            const resultDiv = document.getElementById('penMapResult');
            resultDiv.innerHTML = 'Carregando mapa de currais...';
            
            try {
                const [pensResponse, purchasesResponse] = await Promise.all([
                    fetch(`${API_BASE}/pens`),
                    fetch(`${API_BASE}/cattle-purchases`)
                ]);
                
                const pensData = await pensResponse.json();
                const purchasesData = await purchasesResponse.json();
                
                const pens = pensData.data?.items || [];
                const allocatedPurchases = purchasesData.items.filter(p => 
                    p.stage === 'confined' || p.stage === 'active'
                );
                
                let html = '<div class="metrics">';
                
                pens.forEach(pen => {
                    // Calcular ocupa√ß√£o do curral
                    let occupancy = 0;
                    let lotsInPen = [];
                    
                    allocatedPurchases.forEach(purchase => {
                        const allocation = purchase.penAllocations?.find(a => a.penId === pen.id);
                        if (allocation) {
                            occupancy += allocation.quantity;
                            lotsInPen.push({
                                lotCode: purchase.lotCode,
                                quantity: allocation.quantity
                            });
                        }
                    });
                    
                    const occupancyPercent = (occupancy / pen.capacity) * 100;
                    const statusColor = occupancy === 0 ? '#4caf50' : 
                                       occupancyPercent >= 100 ? '#f44336' : '#ff9800';
                    
                    html += `
                        <div class="metric-card" style="border-left: 4px solid ${statusColor};">
                            <div><strong>üè† Curral ${pen.penNumber}</strong></div>
                            <div>Capacidade: ${pen.capacity}</div>
                            <div>Ocupa√ß√£o: ${occupancy} (${occupancyPercent.toFixed(1)}%)</div>
                            <div>Status: ${pen.status}</div>
                            ${lotsInPen.length > 0 ? `
                                <div style="margin-top: 10px; font-size: 12px;">
                                    <strong>Lotes:</strong><br>
                                    ${lotsInPen.map(l => `${l.lotCode}: ${l.quantity} animais`).join('<br>')}
                                </div>
                            ` : '<div style="margin-top: 10px; color: #666;">Vazio</div>'}
                        </div>
                    `;
                });
                
                html += '</div>';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        // Carregar dados automaticamente ao abrir a p√°gina
        window.onload = () => {
            fetchAllocatedPurchases();
        };
    </script>
</body>
</html>