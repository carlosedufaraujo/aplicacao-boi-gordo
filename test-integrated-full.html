<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Análise Financeira Integrada</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>🧪 Teste da Análise Financeira Integrada</h1>
    <p>Este teste valida a integração completa entre frontend e backend da nova estrutura financeira.</p>

    <div id="status" class="result info">
        <div class="status">Status: Aguardando teste...</div>
    </div>

    <button onclick="runFullTest()">🚀 Executar Teste Completo</button>
    <button onclick="clearResults()">🧹 Limpar Resultados</button>

    <div id="results"></div>

    <script>
        let token = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = `<div class="status">Status: ${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            updateStatus('Aguardando teste...');
        }

        async function makeRequest(url, options = {}) {
            const baseUrl = 'http://localhost:3001';
            const headers = { 'Content-Type': 'application/json' };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(baseUrl + url, {
                ...options,
                headers: { ...headers, ...options.headers }
            });

            const data = await response.json();
            return { response, data };
        }

        async function testLogin() {
            log('🔑 Testando login...', 'info');
            
            try {
                const { response, data } = await makeRequest('/api/v1/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'admin@boicontrol.com',
                        password: 'admin123'
                    })
                });

                if (response.ok && data.token) {
                    token = data.token;
                    log('✅ Login realizado com sucesso', 'success');
                    return true;
                } else {
                    log('❌ Falha no login: ' + (data.message || 'Credenciais inválidas'), 'error');
                    return false;
                }
            } catch (error) {
                log('❌ Erro no login: ' + error.message, 'error');
                return false;
            }
        }

        async function testBackendAPI() {
            log('🔧 Testando APIs do Backend...', 'info');
            
            // Teste 1: Gerar análise integrada
            try {
                log('📊 Gerando análise integrada para setembro/2025...', 'info');
                
                const { response, data } = await makeRequest('/api/v1/integrated-analysis/generate', {
                    method: 'POST',
                    body: JSON.stringify({
                        year: 2025,
                        month: 9,
                        includeNonCashItems: true
                    })
                });

                if (response.ok) {
                    log('✅ Análise integrada gerada com sucesso', 'success');
                    log(`💰 Receita Total: R$ ${data.data.totalRevenue.toFixed(2)}`, 'info');
                    log(`💸 Despesas Total: R$ ${data.data.totalExpenses.toFixed(2)}`, 'info');
                    log(`📈 Resultado Líquido: R$ ${data.data.netIncome.toFixed(2)}`, 'info');
                    log(`💵 Fluxo de Caixa: R$ ${data.data.netCashFlow.toFixed(2)}`, 'info');
                } else {
                    log('⚠️ Problema ao gerar análise: ' + (data.message || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                log('❌ Erro ao gerar análise: ' + error.message, 'error');
            }

            // Teste 2: Buscar análise por período
            try {
                log('🔍 Buscando análise por período...', 'info');
                
                const { response, data } = await makeRequest('/api/v1/integrated-analysis/period/2025/9');

                if (response.ok) {
                    log('✅ Análise por período encontrada', 'success');
                    log(`🔄 Status da Reconciliação: Diferença de R$ ${data.data.reconciliationDifference.toFixed(2)}`, 'info');
                    
                    // Mostrar breakdown do fluxo de caixa
                    const cf = data.data.cashFlowBreakdown;
                    log('💹 Fluxo de Caixa Operacional:', 'info');
                    log(`   • Recebimentos: R$ ${cf.operating.receipts.toFixed(2)}`, 'info');
                    log(`   • Pagamentos: R$ ${cf.operating.payments.toFixed(2)}`, 'info');
                    log(`   • Líquido: R$ ${cf.operating.net.toFixed(2)}`, 'info');
                } else {
                    log('⚠️ Análise por período não encontrada ou erro', 'error');
                }
            } catch (error) {
                log('❌ Erro ao buscar análise por período: ' + error.message, 'error');
            }

            // Teste 3: Dashboard consolidado
            try {
                log('📋 Buscando dashboard consolidado...', 'info');
                
                const { response, data } = await makeRequest('/api/v1/integrated-analysis/dashboard/2025');

                if (response.ok) {
                    log('✅ Dashboard carregado com sucesso', 'success');
                    log(`📊 Resumo Anual 2025:`, 'info');
                    log(`   • Receita Total: R$ ${data.data.summary.totalRevenue.toFixed(2)}`, 'info');
                    log(`   • Margem Líquida: ${data.data.summary.netMargin.toFixed(1)}%`, 'info');
                    log(`   • Margem de Caixa: ${data.data.summary.cashFlowMargin.toFixed(1)}%`, 'info');
                    
                    // Métricas de qualidade
                    const quality = data.data.qualityMetrics;
                    log(`🎯 Métricas de Qualidade:`, 'info');
                    log(`   • Taxa de Conversão Caixa: ${(quality.cashConversionRate * 100).toFixed(1)}%`, 'info');
                    log(`   • Precisão da Reconciliação: ${(quality.reconciliationAccuracy * 100).toFixed(1)}%`, 'info');
                } else {
                    log('⚠️ Dashboard não disponível ou erro', 'error');
                }
            } catch (error) {
                log('❌ Erro ao carregar dashboard: ' + error.message, 'error');
            }
        }

        async function testFrontendIntegration() {
            log('🖥️ Testando integração Frontend...', 'info');
            
            // Verificar se os componentes foram carregados
            const viteDevUrl = 'http://localhost:5173';
            
            try {
                const response = await fetch(viteDevUrl);
                if (response.ok) {
                    log('✅ Frontend (Vite) está rodando', 'success');
                    log('🔗 Acesse: http://localhost:5173', 'info');
                    log('📍 Nova aba "Análise Integrada" disponível no Centro Financeiro', 'success');
                } else {
                    log('⚠️ Frontend não está acessível', 'error');
                }
            } catch (error) {
                log('❌ Erro ao acessar frontend: ' + error.message, 'error');
                log('💡 Certifique-se que o npm run dev está rodando', 'info');
            }
        }

        async function testFullArchitecture() {
            log('🏗️ Testando arquitetura completa...', 'info');
            
            const tests = [
                { name: '🗄️ Modelos do Banco', status: '✅ FinancialTransaction, IntegratedFinancialAnalysis, etc.' },
                { name: '⚙️ Backend Services', status: '✅ IntegratedFinancialAnalysisService implementado' },
                { name: '🛣️ API Routes', status: '✅ /api/v1/integrated-analysis/* disponível' },
                { name: '🎣 Frontend Hooks', status: '✅ useIntegratedFinancialAnalysis criado' },
                { name: '🧩 Components', status: '✅ IntegratedDashboard implementado' },
                { name: '🔗 Integration', status: '✅ Nova aba no Centro Financeiro' }
            ];

            tests.forEach(test => {
                log(`${test.name}: ${test.status}`, 'success');
            });

            log('🎯 Estrutura Paralela: Sistema atual preservado 100%', 'success');
            log('🚀 Funcionalidades: Reconciliação DRE x DFC, análises específicas do agronegócio', 'success');
        }

        async function runFullTest() {
            clearResults();
            updateStatus('Executando testes...');

            log('🧪 Iniciando teste completo da análise financeira integrada', 'info');
            log('=' .repeat(60), 'info');

            // Teste 1: Autenticação
            updateStatus('Testando autenticação...');
            const loginSuccess = await testLogin();
            
            if (!loginSuccess) {
                updateStatus('❌ Falha na autenticação');
                return;
            }

            // Teste 2: Backend APIs
            updateStatus('Testando APIs do backend...');
            await testBackendAPI();

            // Teste 3: Frontend
            updateStatus('Testando frontend...');
            await testFrontendIntegration();

            // Teste 4: Arquitetura geral
            updateStatus('Validando arquitetura...');
            await testFullArchitecture();

            log('=' .repeat(60), 'info');
            log('🏁 Teste completo finalizado!', 'success');
            
            updateStatus('✅ Testes concluídos');
        }

        // Auto-executar após 1 segundo se desejado
        // setTimeout(runFullTest, 1000);
    </script>
</body>
</html>