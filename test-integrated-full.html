<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - AnÃ¡lise Financeira Integrada</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Teste da AnÃ¡lise Financeira Integrada</h1>
    <p>Este teste valida a integraÃ§Ã£o completa entre frontend e backend da nova estrutura financeira.</p>

    <div id="status" class="result info">
        <div class="status">Status: Aguardando teste...</div>
    </div>

    <button onclick="runFullTest()">ğŸš€ Executar Teste Completo</button>
    <button onclick="clearResults()">ğŸ§¹ Limpar Resultados</button>

    <div id="results"></div>

    <script>
        let token = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = `<div class="status">Status: ${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            updateStatus('Aguardando teste...');
        }

        async function makeRequest(url, options = {}) {
            const baseUrl = 'http://localhost:3001';
            const headers = { 'Content-Type': 'application/json' };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(baseUrl + url, {
                ...options,
                headers: { ...headers, ...options.headers }
            });

            const data = await response.json();
            return { response, data };
        }

        async function testLogin() {
            log('ğŸ”‘ Testando login...', 'info');
            
            try {
                const { response, data } = await makeRequest('/api/v1/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'admin@boicontrol.com',
                        password: 'admin123'
                    })
                });

                if (response.ok && data.token) {
                    token = data.token;
                    log('âœ… Login realizado com sucesso', 'success');
                    return true;
                } else {
                    log('âŒ Falha no login: ' + (data.message || 'Credenciais invÃ¡lidas'), 'error');
                    return false;
                }
            } catch (error) {
                log('âŒ Erro no login: ' + error.message, 'error');
                return false;
            }
        }

        async function testBackendAPI() {
            log('ğŸ”§ Testando APIs do Backend...', 'info');
            
            // Teste 1: Gerar anÃ¡lise integrada
            try {
                log('ğŸ“Š Gerando anÃ¡lise integrada para setembro/2025...', 'info');
                
                const { response, data } = await makeRequest('/api/v1/integrated-analysis/generate', {
                    method: 'POST',
                    body: JSON.stringify({
                        year: 2025,
                        month: 9,
                        includeNonCashItems: true
                    })
                });

                if (response.ok) {
                    log('âœ… AnÃ¡lise integrada gerada com sucesso', 'success');
                    log(`ğŸ’° Receita Total: R$ ${data.data.totalRevenue.toFixed(2)}`, 'info');
                    log(`ğŸ’¸ Despesas Total: R$ ${data.data.totalExpenses.toFixed(2)}`, 'info');
                    log(`ğŸ“ˆ Resultado LÃ­quido: R$ ${data.data.netIncome.toFixed(2)}`, 'info');
                    log(`ğŸ’µ Fluxo de Caixa: R$ ${data.data.netCashFlow.toFixed(2)}`, 'info');
                } else {
                    log('âš ï¸ Problema ao gerar anÃ¡lise: ' + (data.message || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                log('âŒ Erro ao gerar anÃ¡lise: ' + error.message, 'error');
            }

            // Teste 2: Buscar anÃ¡lise por perÃ­odo
            try {
                log('ğŸ” Buscando anÃ¡lise por perÃ­odo...', 'info');
                
                const { response, data } = await makeRequest('/api/v1/integrated-analysis/period/2025/9');

                if (response.ok) {
                    log('âœ… AnÃ¡lise por perÃ­odo encontrada', 'success');
                    log(`ğŸ”„ Status da ReconciliaÃ§Ã£o: DiferenÃ§a de R$ ${data.data.reconciliationDifference.toFixed(2)}`, 'info');
                    
                    // Mostrar breakdown do fluxo de caixa
                    const cf = data.data.cashFlowBreakdown;
                    log('ğŸ’¹ Fluxo de Caixa Operacional:', 'info');
                    log(`   â€¢ Recebimentos: R$ ${cf.operating.receipts.toFixed(2)}`, 'info');
                    log(`   â€¢ Pagamentos: R$ ${cf.operating.payments.toFixed(2)}`, 'info');
                    log(`   â€¢ LÃ­quido: R$ ${cf.operating.net.toFixed(2)}`, 'info');
                } else {
                    log('âš ï¸ AnÃ¡lise por perÃ­odo nÃ£o encontrada ou erro', 'error');
                }
            } catch (error) {
                log('âŒ Erro ao buscar anÃ¡lise por perÃ­odo: ' + error.message, 'error');
            }

            // Teste 3: Dashboard consolidado
            try {
                log('ğŸ“‹ Buscando dashboard consolidado...', 'info');
                
                const { response, data } = await makeRequest('/api/v1/integrated-analysis/dashboard/2025');

                if (response.ok) {
                    log('âœ… Dashboard carregado com sucesso', 'success');
                    log(`ğŸ“Š Resumo Anual 2025:`, 'info');
                    log(`   â€¢ Receita Total: R$ ${data.data.summary.totalRevenue.toFixed(2)}`, 'info');
                    log(`   â€¢ Margem LÃ­quida: ${data.data.summary.netMargin.toFixed(1)}%`, 'info');
                    log(`   â€¢ Margem de Caixa: ${data.data.summary.cashFlowMargin.toFixed(1)}%`, 'info');
                    
                    // MÃ©tricas de qualidade
                    const quality = data.data.qualityMetrics;
                    log(`ğŸ¯ MÃ©tricas de Qualidade:`, 'info');
                    log(`   â€¢ Taxa de ConversÃ£o Caixa: ${(quality.cashConversionRate * 100).toFixed(1)}%`, 'info');
                    log(`   â€¢ PrecisÃ£o da ReconciliaÃ§Ã£o: ${(quality.reconciliationAccuracy * 100).toFixed(1)}%`, 'info');
                } else {
                    log('âš ï¸ Dashboard nÃ£o disponÃ­vel ou erro', 'error');
                }
            } catch (error) {
                log('âŒ Erro ao carregar dashboard: ' + error.message, 'error');
            }
        }

        async function testFrontendIntegration() {
            log('ğŸ–¥ï¸ Testando integraÃ§Ã£o Frontend...', 'info');
            
            // Verificar se os componentes foram carregados
            const viteDevUrl = 'http://localhost:5173';
            
            try {
                const response = await fetch(viteDevUrl);
                if (response.ok) {
                    log('âœ… Frontend (Vite) estÃ¡ rodando', 'success');
                    log('ğŸ”— Acesse: http://localhost:5173', 'info');
                    log('ğŸ“ Nova aba "AnÃ¡lise Integrada" disponÃ­vel no Centro Financeiro', 'success');
                } else {
                    log('âš ï¸ Frontend nÃ£o estÃ¡ acessÃ­vel', 'error');
                }
            } catch (error) {
                log('âŒ Erro ao acessar frontend: ' + error.message, 'error');
                log('ğŸ’¡ Certifique-se que o npm run dev estÃ¡ rodando', 'info');
            }
        }

        async function testFullArchitecture() {
            log('ğŸ—ï¸ Testando arquitetura completa...', 'info');
            
            const tests = [
                { name: 'ğŸ—„ï¸ Modelos do Banco', status: 'âœ… FinancialTransaction, IntegratedFinancialAnalysis, etc.' },
                { name: 'âš™ï¸ Backend Services', status: 'âœ… IntegratedFinancialAnalysisService implementado' },
                { name: 'ğŸ›£ï¸ API Routes', status: 'âœ… /api/v1/integrated-analysis/* disponÃ­vel' },
                { name: 'ğŸ£ Frontend Hooks', status: 'âœ… useIntegratedFinancialAnalysis criado' },
                { name: 'ğŸ§© Components', status: 'âœ… IntegratedDashboard implementado' },
                { name: 'ğŸ”— Integration', status: 'âœ… Nova aba no Centro Financeiro' }
            ];

            tests.forEach(test => {
                log(`${test.name}: ${test.status}`, 'success');
            });

            log('ğŸ¯ Estrutura Paralela: Sistema atual preservado 100%', 'success');
            log('ğŸš€ Funcionalidades: ReconciliaÃ§Ã£o DRE x DFC, anÃ¡lises especÃ­ficas do agronegÃ³cio', 'success');
        }

        async function runFullTest() {
            clearResults();
            updateStatus('Executando testes...');

            log('ğŸ§ª Iniciando teste completo da anÃ¡lise financeira integrada', 'info');
            log('=' .repeat(60), 'info');

            // Teste 1: AutenticaÃ§Ã£o
            updateStatus('Testando autenticaÃ§Ã£o...');
            const loginSuccess = await testLogin();
            
            if (!loginSuccess) {
                updateStatus('âŒ Falha na autenticaÃ§Ã£o');
                return;
            }

            // Teste 2: Backend APIs
            updateStatus('Testando APIs do backend...');
            await testBackendAPI();

            // Teste 3: Frontend
            updateStatus('Testando frontend...');
            await testFrontendIntegration();

            // Teste 4: Arquitetura geral
            updateStatus('Validando arquitetura...');
            await testFullArchitecture();

            log('=' .repeat(60), 'info');
            log('ğŸ Teste completo finalizado!', 'success');
            
            updateStatus('âœ… Testes concluÃ­dos');
        }

        // Auto-executar apÃ³s 1 segundo se desejado
        // setTimeout(runFullTest, 1000);
    </script>
</body>
</html>