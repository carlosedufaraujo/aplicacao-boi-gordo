<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste Simples - Currais</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f3f4f6;
    }
    h1 {
      color: #111827;
      border-bottom: 2px solid #10b981;
      padding-bottom: 10px;
    }
    .pen-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .pen-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
      cursor: pointer;
    }
    .pen-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #10b981;
    }
    .pen-card.empty {
      background: #f9fafb;
    }
    .pen-card.partial {
      background: #d1fae5;
      border-color: #10b981;
    }
    .pen-card.full {
      background: #fee2e2;
      border-color: #ef4444;
    }
    .pen-number {
      font-size: 24px;
      font-weight: bold;
      color: #111827;
      margin-bottom: 10px;
    }
    .pen-location {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 15px;
    }
    .pen-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .stat-label {
      color: #6b7280;
      font-size: 12px;
    }
    .stat-value {
      font-weight: 600;
      color: #111827;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, #10b981, #059669);
      transition: width 0.3s;
    }
    .loading {
      text-align: center;
      padding: 40px;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    button {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      margin: 5px;
    }
    button:hover {
      background: #059669;
    }
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e5e7eb;
    }
    .stat-card-value {
      font-size: 28px;
      font-weight: bold;
      color: #111827;
    }
    .stat-card-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>üêÆ Teste Simples - Currais</h1>

  <div id="status"></div>
  
  <button onclick="loadPens()">Recarregar Currais</button>
  <button onclick="testAllocation()">Testar Aloca√ß√£o</button>

  <div class="stats-summary" id="stats"></div>
  
  <div class="pen-grid" id="pens"></div>

  <script>
    const API_URL = 'http://localhost:3001/api/v1';
    let authToken = null;
    let pensData = [];

    // Login autom√°tico
    async function autoLogin() {
      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'admin@boicontrol.com',
            password: 'admin123'
          })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
          authToken = data.data.token;
          localStorage.setItem('token', authToken);
          document.getElementById('status').innerHTML = '<div class="success">‚úÖ Login realizado com sucesso!</div>';
          return true;
        }
        return false;
      } catch (error) {
        console.error('Erro no login:', error);
        document.getElementById('status').innerHTML = '<div class="error">‚ùå Erro no login: ' + error.message + '</div>';
        return false;
      }
    }

    async function loadPens() {
      document.getElementById('pens').innerHTML = '<div class="loading">Carregando currais...</div>';
      
      try {
        if (!authToken) {
          const loginSuccess = await autoLogin();
          if (!loginSuccess) {
            throw new Error('Falha no login');
          }
        }
        
        const response = await fetch(`${API_URL}/pens`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        const result = await response.json();
        console.log('Resposta da API:', result);
        
        if (result.status === 'success') {
          pensData = result.data.items || result.data || [];
          
          // Atualizar estat√≠sticas
          updateStats();
          
          // Renderizar currais
          renderPens();
          
          document.getElementById('status').innerHTML = `<div class="success">‚úÖ ${pensData.length} currais carregados com sucesso!</div>`;
        } else {
          throw new Error(result.message || 'Erro ao carregar currais');
        }
      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('status').innerHTML = '<div class="error">‚ùå Erro ao carregar currais: ' + error.message + '</div>';
        document.getElementById('pens').innerHTML = '';
      }
    }

    function updateStats() {
      const totalPens = pensData.length;
      const totalCapacity = pensData.reduce((sum, pen) => sum + pen.capacity, 0);
      const totalOccupancy = pensData.reduce((sum, pen) => sum + (pen.currentOccupancy || 0), 0);
      const availablePens = pensData.filter(pen => (pen.currentOccupancy || 0) === 0).length;
      const fullPens = pensData.filter(pen => (pen.currentOccupancy || 0) >= pen.capacity).length;
      const partialPens = totalPens - availablePens - fullPens;
      const occupancyRate = totalCapacity > 0 ? (totalOccupancy / totalCapacity * 100).toFixed(1) : 0;

      document.getElementById('stats').innerHTML = `
        <div class="stat-card">
          <div class="stat-card-value">${totalPens}</div>
          <div class="stat-card-label">Total Currais</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${availablePens}</div>
          <div class="stat-card-label">Dispon√≠veis</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${partialPens}</div>
          <div class="stat-card-label">Parcialmente Ocupados</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${fullPens}</div>
          <div class="stat-card-label">Lotados</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${totalOccupancy}</div>
          <div class="stat-card-label">Total Animais</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${totalCapacity}</div>
          <div class="stat-card-label">Capacidade Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${occupancyRate}%</div>
          <div class="stat-card-label">Taxa de Ocupa√ß√£o</div>
        </div>
      `;
    }

    function renderPens() {
      const pensDiv = document.getElementById('pens');
      
      if (pensData.length === 0) {
        pensDiv.innerHTML = '<div class="error">Nenhum curral encontrado</div>';
        return;
      }

      pensDiv.innerHTML = pensData.map(pen => {
        const occupancy = pen.currentOccupancy || 0;
        const occupancyRate = pen.capacity > 0 ? (occupancy / pen.capacity * 100) : 0;
        
        let statusClass = 'empty';
        if (occupancyRate >= 100) statusClass = 'full';
        else if (occupancyRate > 0) statusClass = 'partial';
        
        return `
          <div class="pen-card ${statusClass}" onclick="selectPen('${pen.penNumber}')">
            <div class="pen-number">Curral ${pen.penNumber}</div>
            <div class="pen-location">${pen.location || 'Sem localiza√ß√£o'}</div>
            
            <div class="pen-stats">
              <div>
                <div class="stat-label">Capacidade</div>
                <div class="stat-value">${pen.capacity}</div>
              </div>
              <div>
                <div class="stat-label">Ocupa√ß√£o</div>
                <div class="stat-value">${occupancy}</div>
              </div>
              <div>
                <div class="stat-label">Dispon√≠vel</div>
                <div class="stat-value">${pen.capacity - occupancy}</div>
              </div>
            </div>
            
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${occupancyRate}%"></div>
            </div>
            <div style="text-align: center; margin-top: 5px; font-size: 12px; color: #6b7280;">
              ${occupancyRate.toFixed(0)}% ocupado
            </div>
          </div>
        `;
      }).join('');
    }

    function selectPen(penNumber) {
      const pen = pensData.find(p => p.penNumber === penNumber);
      if (pen) {
        alert(`
Curral ${pen.penNumber} selecionado!

Localiza√ß√£o: ${pen.location || 'N√£o especificada'}
Capacidade: ${pen.capacity} animais
Ocupa√ß√£o atual: ${pen.currentOccupancy || 0} animais
Dispon√≠vel: ${pen.capacity - (pen.currentOccupancy || 0)} animais
Status: ${pen.status}
Tipo: ${pen.type}

Para alocar animais neste curral, use o sistema principal.
        `);
      }
    }

    function testAllocation() {
      if (pensData.length === 0) {
        alert('Carregue os currais primeiro!');
        return;
      }
      
      const availablePens = pensData.filter(pen => (pen.currentOccupancy || 0) < pen.capacity);
      
      if (availablePens.length === 0) {
        alert('N√£o h√° currais dispon√≠veis para aloca√ß√£o!');
        return;
      }
      
      const pen = availablePens[0];
      alert(`
Teste de Aloca√ß√£o

Curral dispon√≠vel: ${pen.penNumber}
Capacidade restante: ${pen.capacity - (pen.currentOccupancy || 0)} animais

Para realizar a aloca√ß√£o:
1. Acesse o sistema principal
2. V√° para a se√ß√£o de Lotes
3. Selecione ou crie um lote
4. Use a op√ß√£o "Alocar em Curral"
5. Selecione o curral ${pen.penNumber}
      `);
    }

    // Carregar currais ao abrir a p√°gina
    window.onload = loadPens;
  </script>
</body>
</html>