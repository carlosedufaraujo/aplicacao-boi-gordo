<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Parceiros</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Teste de Parceiros - API Backend</h1>
    
    <div>
        <button onclick="testAPI()">Testar API com Token</button>
        <button onclick="listPartners()">Listar Parceiros</button>
        <button onclick="createTestPartner()">Criar Parceiro Teste</button>
    </div>
    
    <h2>Resultado:</h2>
    <pre id="result"></pre>
    
    <div id="table-container"></div>

    <script>
        const API_URL = 'http://localhost:3001/api/v1';
        const TOKEN = localStorage.getItem('authToken');
        
        function updateResult(message, isError = false) {
            const resultEl = document.getElementById('result');
            resultEl.className = isError ? 'error' : 'success';
            resultEl.textContent = message;
        }
        
        async function testAPI() {
            try {
                updateResult('Testando conexão com a API...');
                
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateResult('✅ API conectada! Usuário: ' + data.data.email);
                } else {
                    updateResult('❌ Erro na autenticação. Status: ' + response.status, true);
                }
            } catch (error) {
                updateResult('❌ Erro de conexão: ' + error.message, true);
            }
        }
        
        async function listPartners() {
            try {
                updateResult('Buscando parceiros...');
                
                const response = await fetch(`${API_URL}/partners`, {
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Resposta completa:', data);
                
                if (response.ok && data.status === 'success') {
                    const partners = data.data.items || data.data || [];
                    updateResult(`✅ ${partners.length} parceiro(s) encontrado(s)`);
                    
                    // Criar tabela
                    if (partners.length > 0) {
                        let tableHTML = '<table><tr><th>Nome</th><th>Tipo</th><th>CPF/CNPJ</th><th>Email</th><th>Telefone</th><th>Ativo</th></tr>';
                        partners.forEach(p => {
                            tableHTML += `<tr>
                                <td>${p.name}</td>
                                <td>${p.type}</td>
                                <td>${p.cpfCnpj || '-'}</td>
                                <td>${p.email || '-'}</td>
                                <td>${p.phone || '-'}</td>
                                <td>${p.isActive ? '✅' : '❌'}</td>
                            </tr>`;
                        });
                        tableHTML += '</table>';
                        document.getElementById('table-container').innerHTML = tableHTML;
                    } else {
                        document.getElementById('table-container').innerHTML = '<p>Nenhum parceiro cadastrado</p>';
                    }
                } else {
                    updateResult('❌ Erro ao buscar parceiros: ' + (data.message || 'Erro desconhecido'), true);
                }
            } catch (error) {
                updateResult('❌ Erro: ' + error.message, true);
            }
        }
        
        async function createTestPartner() {
            try {
                updateResult('Criando parceiro de teste...');
                
                const testPartner = {
                    name: 'Parceiro Teste ' + new Date().getTime(),
                    type: 'VENDOR',
                    cpfCnpj: '12345678901',
                    email: 'teste@exemplo.com',
                    phone: '11999999999',
                    address: 'Rua Teste, 123',
                    notes: 'Criado via teste HTML',
                    isActive: true
                };
                
                const response = await fetch(`${API_URL}/partners`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testPartner)
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    updateResult('✅ Parceiro criado com sucesso! ID: ' + data.data.id);
                    // Recarregar lista
                    setTimeout(listPartners, 1000);
                } else {
                    updateResult('❌ Erro ao criar parceiro: ' + (data.message || 'Erro desconhecido'), true);
                }
            } catch (error) {
                updateResult('❌ Erro: ' + error.message, true);
            }
        }
        
        // Testar automaticamente ao carregar
        window.onload = () => {
            if (!TOKEN) {
                updateResult('❌ Token não encontrado. Faça login primeiro!', true);
            } else {
                updateResult('Token encontrado: ' + TOKEN.substring(0, 20) + '...');
                testAPI();
            }
        };
    </script>
</body>
</html>