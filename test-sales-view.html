<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Visualiza√ß√£o de Vendas</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.loading {
            background: #ffc107;
            color: #333;
        }
        .status.success {
            background: #28a745;
            color: white;
        }
        .status.error {
            background: #dc3545;
            color: white;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge.pending {
            background: #ffc107;
            color: #333;
        }
        .badge.paid {
            background: #28a745;
            color: white;
        }
        .badge.confirmed {
            background: #17a2b8;
            color: white;
        }
        .error-details {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }
        .debug-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            color: #004085;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêÆ Teste de Visualiza√ß√£o de Vendas</h1>
        
        <div id="status" class="status loading">
            Carregando dados...
        </div>

        <div id="debug-info" class="debug-info" style="display: none;">
            <h3>Informa√ß√µes de Debug:</h3>
            <div id="debug-content"></div>
        </div>
        
        <div id="error-container" style="display: none;">
            <div class="error-details">
                <h3>‚ùå Erro ao carregar vendas:</h3>
                <p id="error-message"></p>
            </div>
        </div>

        <div id="stats-container" class="stats" style="display: none;">
            <div class="stat-card">
                <h3>Total de Vendas</h3>
                <div class="value" id="total-sales">0</div>
            </div>
            <div class="stat-card">
                <h3>Valor Total</h3>
                <div class="value" id="total-value">R$ 0</div>
            </div>
            <div class="stat-card">
                <h3>Total de Animais</h3>
                <div class="value" id="total-animals">0</div>
            </div>
            <div class="stat-card">
                <h3>Peso Total</h3>
                <div class="value" id="total-weight">0 kg</div>
            </div>
        </div>

        <div id="table-container" style="display: none;">
            <h2>Vendas Cadastradas</h2>
            <table id="sales-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Curral/Lote</th>
                        <th>Comprador</th>
                        <th>Quantidade</th>
                        <th>Peso Sa√≠da</th>
                        <th>Peso Carca√ßa</th>
                        <th>Valor Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="sales-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api/v1';
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatWeight(value) {
            return new Intl.NumberFormat('pt-BR').format(value) + ' kg';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function getStatusBadge(status) {
            const statusMap = {
                'PENDING': '<span class="badge pending">Pendente</span>',
                'PAID': '<span class="badge paid">Pago</span>',
                'CONFIRMED': '<span class="badge confirmed">Confirmado</span>',
                'DELIVERED': '<span class="badge confirmed">Entregue</span>',
                'CANCELLED': '<span class="badge error">Cancelado</span>'
            };
            return statusMap[status] || status;
        }

        async function loadSales() {
            const statusEl = document.getElementById('status');
            const errorContainer = document.getElementById('error-container');
            const statsContainer = document.getElementById('stats-container');
            const tableContainer = document.getElementById('table-container');
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            
            try {
                statusEl.textContent = 'Buscando vendas na API...';
                statusEl.className = 'status loading';
                
                // Fazer requisi√ß√£o para API
                const response = await fetch(`${API_URL}/sale-records`);
                const responseText = await response.text();
                
                // Debug info
                debugInfo.style.display = 'block';
                debugContent.innerHTML = `
                    <strong>URL:</strong> ${API_URL}/sale-records<br>
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>Response Length:</strong> ${responseText.length} bytes<br>
                `;
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}\nResponse: ${responseText}`);
                }
                
                const data = JSON.parse(responseText);
                console.log('Dados recebidos:', data);
                
                // Adicionar mais debug info
                debugContent.innerHTML += `
                    <strong>Data Structure:</strong> ${JSON.stringify(Object.keys(data), null, 2)}<br>
                    <strong>Items Count:</strong> ${data.data?.items?.length || data.data?.length || 0}<br>
                `;
                
                // Extrair vendas - tentar diferentes estruturas
                let sales = [];
                if (data.data?.items) {
                    sales = data.data.items;
                } else if (Array.isArray(data.data)) {
                    sales = data.data;
                } else if (Array.isArray(data)) {
                    sales = data;
                }
                
                if (sales.length === 0) {
                    statusEl.textContent = '‚ö†Ô∏è Nenhuma venda encontrada';
                    statusEl.className = 'status error';
                    debugContent.innerHTML += `<br><strong style="color: red;">Nenhuma venda encontrada na resposta!</strong>`;
                    return;
                }
                
                // Calcular estat√≠sticas
                const stats = {
                    totalSales: sales.length,
                    totalValue: sales.reduce((sum, sale) => sum + (sale.totalValue || 0), 0),
                    totalAnimals: sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0),
                    totalWeight: sales.reduce((sum, sale) => sum + (sale.exitWeight || 0), 0)
                };
                
                // Atualizar estat√≠sticas
                document.getElementById('total-sales').textContent = stats.totalSales;
                document.getElementById('total-value').textContent = formatCurrency(stats.totalValue);
                document.getElementById('total-animals').textContent = stats.totalAnimals;
                document.getElementById('total-weight').textContent = formatWeight(stats.totalWeight);
                
                // Atualizar tabela
                const tbody = document.getElementById('sales-tbody');
                tbody.innerHTML = '';
                
                sales.forEach(sale => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${formatDate(sale.saleDate)}</td>
                        <td>${sale.pen?.penNumber || sale.purchase?.lotCode || '-'}</td>
                        <td>${sale.buyer?.name || 'Desconhecido'}</td>
                        <td>${sale.quantity}</td>
                        <td>${formatWeight(sale.exitWeight)}</td>
                        <td>${formatWeight(sale.carcassWeight)}</td>
                        <td>${formatCurrency(sale.totalValue)}</td>
                        <td>${getStatusBadge(sale.status)}</td>
                    `;
                });
                
                // Mostrar containers
                statsContainer.style.display = 'grid';
                tableContainer.style.display = 'block';
                errorContainer.style.display = 'none';
                
                statusEl.textContent = `‚úÖ ${sales.length} vendas carregadas com sucesso!`;
                statusEl.className = 'status success';
                
            } catch (error) {
                console.error('Erro ao carregar vendas:', error);
                
                statusEl.textContent = '‚ùå Erro ao carregar vendas';
                statusEl.className = 'status error';
                
                document.getElementById('error-message').textContent = error.message;
                errorContainer.style.display = 'block';
                statsContainer.style.display = 'none';
                tableContainer.style.display = 'none';
                
                debugContent.innerHTML += `<br><strong style="color: red;">ERRO:</strong> ${error.message}`;
            }
        }
        
        // Carregar vendas ao abrir a p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            loadSales();
            
            // Recarregar a cada 30 segundos
            setInterval(loadSales, 30000);
        });
    </script>
</body>
</html>