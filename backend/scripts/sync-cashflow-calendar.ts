#!/usr/bin/env tsx
/**
 * Script para sincronizar movimentaÃ§Ãµes de Cash Flow existentes com o CalendÃ¡rio
 * Este script criarÃ¡ eventos no calendÃ¡rio para todas as movimentaÃ§Ãµes que ainda nÃ£o possuem eventos
 */

import { PrismaClient } from '@prisma/client';
import { CalendarEventService } from '../src/services/calendarEvent.service';

const prisma = new PrismaClient();
const calendarEventService = new CalendarEventService();

async function syncCashFlowWithCalendar() {
  console.log('ğŸ”„ Iniciando sincronizaÃ§Ã£o de Cash Flow com CalendÃ¡rio...\n');

  try {
    // Buscar todas as movimentaÃ§Ãµes de cash flow
    const cashFlows = await prisma.cashFlow.findMany({
      orderBy: { createdAt: 'asc' }
    });

    console.log(`ğŸ“Š Total de movimentaÃ§Ãµes encontradas: ${cashFlows.length}`);

    // Buscar eventos existentes para evitar duplicaÃ§Ã£o
    const existingEvents = await calendarEventService.findEvents({ type: 'FINANCE' });
    const existingRelatedIds = new Set(existingEvents.map(e => e.relatedId).filter(Boolean));
    
    console.log(`ğŸ“… Eventos jÃ¡ existentes no calendÃ¡rio: ${existingEvents.length}`);

    let created = 0;
    let skipped = 0;
    let errors = 0;

    for (const cashFlow of cashFlows) {
      // Verificar se jÃ¡ existe evento para este cash flow
      if (existingRelatedIds.has(cashFlow.id)) {
        console.log(`â­ï¸  Pulando: ${cashFlow.description} (jÃ¡ possui evento)`);
        skipped++;
        continue;
      }

      try {
        // Preparar dados do evento
        const eventDate = cashFlow.dueDate || cashFlow.date;
        const eventTitle = cashFlow.type === 'INCOME' 
          ? `ğŸ’° Receita: ${cashFlow.description}`
          : `ğŸ’¸ Despesa: ${cashFlow.description}`;
        
        const eventColor = cashFlow.type === 'INCOME' ? '#10b981' : '#ef4444';
        const eventStatus = (cashFlow.status === 'PAID' || cashFlow.status === 'RECEIVED') 
          ? 'COMPLETED' 
          : 'SCHEDULED';

        // Criar evento no calendÃ¡rio
        const event = await calendarEventService.createEvent({
          title: eventTitle,
          description: `${cashFlow.type === 'INCOME' ? 'Receita' : 'Despesa'}: ${new Intl.NumberFormat('pt-BR', { 
            style: 'currency', 
            currency: 'BRL' 
          }).format(cashFlow.amount)}\n${cashFlow.notes || ''}`,
          type: 'FINANCE',
          date: new Date(eventDate),
          status: eventStatus,
          priority: cashFlow.amount > 10000 ? 'HIGH' : 'MEDIUM',
          tags: ['financeiro', cashFlow.type.toLowerCase(), 'sincronizado'],
          color: eventColor,
          relatedId: cashFlow.id,
          amount: cashFlow.amount,
          autoGenerated: true,
          userId: cashFlow.userId
        });

        console.log(`âœ… Criado evento para: ${cashFlow.description}`);
        created++;
      } catch (error) {
        console.error(`âŒ Erro ao criar evento para: ${cashFlow.description}`, error);
        errors++;
      }
    }

    console.log('\nğŸ“Š === RESUMO DA SINCRONIZAÃ‡ÃƒO ===');
    console.log(`âœ… Eventos criados: ${created}`);
    console.log(`â­ï¸  MovimentaÃ§Ãµes puladas (jÃ¡ tinham evento): ${skipped}`);
    console.log(`âŒ Erros encontrados: ${errors}`);
    console.log(`ğŸ“… Total de eventos no calendÃ¡rio agora: ${existingEvents.length + created}`);

    // Verificar integridade
    const finalEvents = await calendarEventService.findEvents({ type: 'FINANCE' });
    const cashFlowsWithoutEvents = cashFlows.filter(cf => 
      !finalEvents.some(e => e.relatedId === cf.id)
    );

    if (cashFlowsWithoutEvents.length > 0) {
      console.log(`\nâš ï¸  Ainda existem ${cashFlowsWithoutEvents.length} movimentaÃ§Ãµes sem eventos no calendÃ¡rio.`);
      console.log('MovimentaÃ§Ãµes sem eventos:');
      cashFlowsWithoutEvents.forEach(cf => {
        console.log(`  - ${cf.description} (ID: ${cf.id})`);
      });
    } else {
      console.log('\nâœ… Todas as movimentaÃ§Ãµes agora possuem eventos no calendÃ¡rio!');
    }

  } catch (error) {
    console.error('âŒ Erro durante a sincronizaÃ§Ã£o:', error);
    process.exit(1);
  } finally {
    await prisma.$disconnect();
  }
}

// Executar sincronizaÃ§Ã£o
syncCashFlowWithCalendar()
  .then(() => {
    console.log('\nâœ¨ SincronizaÃ§Ã£o concluÃ­da com sucesso!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('âŒ Erro fatal:', error);
    process.exit(1);
  });