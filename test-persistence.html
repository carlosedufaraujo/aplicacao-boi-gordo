<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Persist√™ncia de Dados</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .data-list { margin: 10px 0; }
        .data-item { padding: 8px; background: #f9f9f9; margin: 5px 0; border-radius: 4px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste de Persist√™ncia de Dados</h1>
        
        <div class="section">
            <h2>üìä Status da Conex√£o</h2>
            <div id="status">Verificando...</div>
        </div>

        <div class="section">
            <h2>üë• Parceiros</h2>
            <button onclick="loadPartners()">Carregar Parceiros</button>
            <button onclick="createTestPartner()">Criar Parceiro Teste</button>
            <div id="partners" class="data-list"></div>
        </div>

        <div class="section">
            <h2>üîÑ Ciclos</h2>
            <button onclick="loadCycles()">Carregar Ciclos</button>
            <button onclick="createTestCycle()">Criar Ciclo Teste</button>
            <div id="cycles" class="data-list"></div>
        </div>

        <div class="section">
            <h2>üí≥ Contas Pagadoras</h2>
            <button onclick="loadPayerAccounts()">Carregar Contas</button>
            <button onclick="createTestPayerAccount()">Criar Conta Teste</button>
            <div id="payerAccounts" class="data-list"></div>
        </div>

        <div class="section">
            <h2>üè† Currais</h2>
            <button onclick="loadPens()">Carregar Currais</button>
            <button onclick="createTestPen()">Criar Curral Teste</button>
            <div id="pens" class="data-list"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api/v1';
        let authToken = null;

        async function authenticate() {
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@boigordo.com',
                        password: 'Admin123!@#'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    document.getElementById('status').innerHTML = '<span class="success">‚úÖ Conectado ao backend</span>';
                    
                    // Carregar todos os dados automaticamente
                    await Promise.all([
                        loadPartners(),
                        loadCycles(),
                        loadPayerAccounts(),
                        loadPens()
                    ]);
                } else {
                    throw new Error('Falha na autentica√ß√£o');
                }
            } catch (error) {
                document.getElementById('status').innerHTML = `<span class="error">‚ùå Erro: ${error.message}</span>`;
            }
        }

        async function loadPartners() {
            try {
                const response = await fetch(`${API_URL}/partners`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('partners');
                const items = data.items || [];
                
                if (items.length > 0) {
                    container.innerHTML = items.map(p => 
                        `<div class="data-item">
                            <strong>${p.name}</strong> - ${p.partnerType || 'N/A'} 
                            ${p.isActive ? '‚úÖ Ativo' : '‚ùå Inativo'}
                        </div>`
                    ).join('');
                } else {
                    container.innerHTML = '<div class="info">Nenhum parceiro encontrado</div>';
                }
                
                console.log('Parceiros carregados:', items);
            } catch (error) {
                document.getElementById('partners').innerHTML = `<span class="error">Erro: ${error.message}</span>`;
            }
        }

        async function loadCycles() {
            try {
                const response = await fetch(`${API_URL}/cycles`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('cycles');
                const items = data.items || [];
                
                if (items.length > 0) {
                    container.innerHTML = items.map(c => 
                        `<div class="data-item">
                            <strong>${c.name}</strong> - ${c.status || 'N/A'}
                            ${c.isActive ? '‚úÖ Ativo' : '‚ùå Inativo'}
                        </div>`
                    ).join('');
                } else {
                    container.innerHTML = '<div class="info">Nenhum ciclo encontrado</div>';
                }
                
                console.log('Ciclos carregados:', items);
            } catch (error) {
                document.getElementById('cycles').innerHTML = `<span class="error">Erro: ${error.message}</span>`;
            }
        }

        async function loadPayerAccounts() {
            try {
                const response = await fetch(`${API_URL}/payer-accounts`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('payerAccounts');
                const items = data.items || [];
                
                if (items.length > 0) {
                    container.innerHTML = items.map(a => 
                        `<div class="data-item">
                            <strong>${a.name}</strong> - Banco: ${a.bankName || 'N/A'}
                            ${a.isActive ? '‚úÖ Ativa' : '‚ùå Inativa'}
                        </div>`
                    ).join('');
                } else {
                    container.innerHTML = '<div class="info">Nenhuma conta encontrada</div>';
                }
                
                console.log('Contas carregadas:', items);
            } catch (error) {
                document.getElementById('payerAccounts').innerHTML = `<span class="error">Erro: ${error.message}</span>`;
            }
        }

        async function loadPens() {
            try {
                const response = await fetch(`${API_URL}/pens`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('pens');
                const items = data.items || [];
                
                if (items.length > 0) {
                    container.innerHTML = items.map(p => 
                        `<div class="data-item">
                            <strong>${p.code}</strong> - Capacidade: ${p.capacity || 0}
                            - Ocupa√ß√£o: ${p.currentOccupancy || 0}/${p.capacity || 0}
                        </div>`
                    ).join('');
                } else {
                    container.innerHTML = '<div class="info">Nenhum curral encontrado</div>';
                }
                
                console.log('Currais carregados:', items);
            } catch (error) {
                document.getElementById('pens').innerHTML = `<span class="error">Erro: ${error.message}</span>`;
            }
        }

        async function createTestPartner() {
            try {
                const response = await fetch(`${API_URL}/partners`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: `Parceiro Teste ${Date.now()}`,
                        partnerType: 'Fornecedor',
                        document: `12345678${Date.now().toString().slice(-6)}`,
                        email: `teste${Date.now()}@example.com`,
                        phone: '11999999999',
                        isActive: true
                    })
                });
                
                if (response.ok) {
                    alert('Parceiro criado com sucesso!');
                    await loadPartners();
                } else {
                    throw new Error('Erro ao criar parceiro');
                }
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        async function createTestCycle() {
            try {
                const response = await fetch(`${API_URL}/cycles`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: `Ciclo Teste ${Date.now()}`,
                        startDate: new Date().toISOString(),
                        status: 'Ativo',
                        isActive: true
                    })
                });
                
                if (response.ok) {
                    alert('Ciclo criado com sucesso!');
                    await loadCycles();
                } else {
                    throw new Error('Erro ao criar ciclo');
                }
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        async function createTestPayerAccount() {
            try {
                const response = await fetch(`${API_URL}/payer-accounts`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: `Conta Teste ${Date.now()}`,
                        bankName: 'Banco do Brasil',
                        accountNumber: Date.now().toString().slice(-8),
                        isActive: true
                    })
                });
                
                if (response.ok) {
                    alert('Conta criada com sucesso!');
                    await loadPayerAccounts();
                } else {
                    throw new Error('Erro ao criar conta');
                }
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        async function createTestPen() {
            try {
                const response = await fetch(`${API_URL}/pens`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: `PEN-${Date.now().toString().slice(-4)}`,
                        capacity: 100,
                        currentOccupancy: 0,
                        penType: 'Confinamento',
                        location: 'Fazenda A'
                    })
                });
                
                if (response.ok) {
                    alert('Curral criado com sucesso!');
                    await loadPens();
                } else {
                    throw new Error('Erro ao criar curral');
                }
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        // Inicializar ao carregar
        window.onload = authenticate;
    </script>
</body>
</html>