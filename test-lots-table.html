<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste - Tabela de Lotes</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0; }
        .stat-card h3 { font-size: 12px; color: #666; margin: 0 0 5px 0; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #333; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f5f5f5; padding: 12px; text-align: left; font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e0e0e0; font-size: 14px; }
        tr:hover { background: #f9f9f9; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge.confirmed { background: #fff3e0; color: #e65100; }
        .badge.confined { background: #e3f2fd; color: #1565c0; }
        .badge.active { background: #e8f5e9; color: #2e7d32; }
        .badge.sold { background: #f3e5f5; color: #6a1b9a; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 4px; }
        .success { background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 4px; }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; }
        .filter { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>游닍 Teste - Tabela Completa de Lotes</h1>
        
        <div class="filters">
            <select id="stageFilter" class="filter" onchange="loadLots()">
                <option value="all">Todos os Est치gios</option>
                <option value="confirmed">Confirmados</option>
                <option value="confined">Confinados</option>
                <option value="active">Ativos</option>
                <option value="in_transit">Em Tr칙nsito</option>
                <option value="received">Recebidos</option>
                <option value="sold">Vendidos</option>
            </select>
            
            <button class="filter" onclick="loadLots()">游댃 Atualizar</button>
        </div>
        
        <div id="stats" class="stats"></div>
        <div id="lotsTable"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/v1';
        
        async function loadLots() {
            const stageFilter = document.getElementById('stageFilter').value;
            const statsDiv = document.getElementById('stats');
            const tableDiv = document.getElementById('lotsTable');
            
            statsDiv.innerHTML = '<div class="loading">Carregando estat칤sticas...</div>';
            tableDiv.innerHTML = '<div class="loading">Carregando lotes...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/cattle-purchases`);
                const data = await response.json();
                const allLots = data.items || [];
                
                // Filtrar por est치gio se necess치rio
                const filteredLots = stageFilter === 'all' 
                    ? allLots 
                    : allLots.filter(lot => lot.stage === stageFilter);
                
                // Calcular estat칤sticas
                const stats = {
                    total: allLots.length,
                    confirmed: allLots.filter(l => l.stage === 'confirmed').length,
                    confined: allLots.filter(l => l.stage === 'confined' || l.stage === 'active').length,
                    inTransit: allLots.filter(l => l.stage === 'in_transit').length,
                    received: allLots.filter(l => l.stage === 'received').length,
                    sold: allLots.filter(l => l.stage === 'sold').length,
                    totalAnimals: allLots.reduce((sum, l) => sum + l.currentQuantity, 0),
                    totalInvestment: allLots.reduce((sum, l) => sum + l.totalCost, 0)
                };
                
                // Exibir estat칤sticas
                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <h3>Total de Lotes</h3>
                        <div class="value">${stats.total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Confirmados</h3>
                        <div class="value">${stats.confirmed}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Confinados</h3>
                        <div class="value">${stats.confined}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Em Tr칙nsito</h3>
                        <div class="value">${stats.inTransit}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total de Animais</h3>
                        <div class="value">${stats.totalAnimals.toLocaleString('pt-BR')}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Investimento Total</h3>
                        <div class="value">R$ ${(stats.totalInvestment / 1000).toFixed(1)}k</div>
                    </div>
                `;
                
                // Exibir tabela
                if (filteredLots.length === 0) {
                    tableDiv.innerHTML = '<div class="error">Nenhum lote encontrado com o filtro aplicado</div>';
                    return;
                }
                
                tableDiv.innerHTML = `
                    <h2>游늶 Lista de Lotes (${filteredLots.length} ${stageFilter === 'all' ? 'total' : 'filtrados'})</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>C칩digo</th>
                                <th>Est치gio</th>
                                <th>Status</th>
                                <th>Fornecedor</th>
                                <th>Localiza칞칚o</th>
                                <th>Quantidade</th>
                                <th>Peso M칠dio</th>
                                <th>Investimento</th>
                                <th>Data Compra</th>
                                <th>Aloca칞칚o</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredLots.map(lot => {
                                const stageBadge = getStageStyle(lot.stage);
                                const statusBadge = lot.status ? `<span class="badge" style="background: #f0f0f0; color: #666;">${lot.status}</span>` : '-';
                                const allocation = lot.penAllocations && lot.penAllocations.length > 0
                                    ? `Curral ${lot.penAllocations[0].pen?.penNumber || 'N/A'} (${lot.penAllocations[0].quantity} animais)`
                                    : 'N칚o alocado';
                                
                                return `
                                    <tr>
                                        <td><strong>${lot.lotCode}</strong></td>
                                        <td><span class="badge ${stageBadge.class}">${stageBadge.label}</span></td>
                                        <td>${statusBadge}</td>
                                        <td>${lot.vendor?.name || 'N/A'}</td>
                                        <td>${lot.city || 'N/A'} - ${lot.state || 'N/A'}</td>
                                        <td>${lot.currentQuantity}/${lot.initialQuantity}</td>
                                        <td>${lot.averageWeight ? lot.averageWeight.toFixed(1) + ' kg' : 'N/A'}</td>
                                        <td>R$ ${lot.totalCost.toLocaleString('pt-BR')}</td>
                                        <td>${new Date(lot.purchaseDate).toLocaleDateString('pt-BR')}</td>
                                        <td>${allocation}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 4px;">
                        <strong>Resumo:</strong>
                        <ul style="margin-top: 10px;">
                            <li>${filteredLots.filter(l => l.penAllocations && l.penAllocations.length > 0).length} lotes alocados em currais</li>
                            <li>${filteredLots.filter(l => !l.penAllocations || l.penAllocations.length === 0).length} lotes aguardando aloca칞칚o</li>
                            <li>${filteredLots.filter(l => l.stage === 'confirmed').length} lotes confirmados (precisam recep칞칚o)</li>
                            <li>${filteredLots.filter(l => l.stage === 'confined' || l.stage === 'active').length} lotes j치 confinados</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">Erro ao carregar dados: ${error.message}</div>`;
                tableDiv.innerHTML = '';
            }
        }
        
        function getStageStyle(stage) {
            switch(stage) {
                case 'confirmed': return { class: 'confirmed', label: 'Confirmado' };
                case 'confined': return { class: 'confined', label: 'Confinado' };
                case 'active': return { class: 'active', label: 'Ativo' };
                case 'in_transit': return { class: 'confirmed', label: 'Em Tr칙nsito' };
                case 'received': return { class: 'confined', label: 'Recebido' };
                case 'sold': return { class: 'sold', label: 'Vendido' };
                default: return { class: '', label: stage || 'N/A' };
            }
        }
        
        // Carregar dados ao abrir a p치gina
        window.onload = () => loadLots();
    </script>
</body>
</html>