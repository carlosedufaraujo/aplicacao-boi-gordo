<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Visualiza√ß√£o de Dados Financeiros</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .tab-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: white;
            font-weight: bold;
            color: #4CAF50;
        }
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .summary-card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .data-table th,
        .data-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .data-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .data-table tbody tr:hover {
            background-color: #f9f9f9;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-paid {
            background: #d4edda;
            color: #155724;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .expense {
            color: #dc3545;
        }
        .income {
            color: #28a745;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Teste de Visualiza√ß√£o Financeira</h1>
        
        <div class="summary-grid" id="summary">
            <div class="summary-card">
                <h3>Total de Despesas</h3>
                <div class="value" id="totalExpenses">Carregando...</div>
            </div>
            <div class="summary-card">
                <h3>Total de Receitas</h3>
                <div class="value" id="totalRevenues">Carregando...</div>
            </div>
            <div class="summary-card">
                <h3>Saldo</h3>
                <div class="value" id="balance">Carregando...</div>
            </div>
        </div>

        <div class="tab-container">
            <div class="tab active" onclick="showTab('all')">Todas</div>
            <div class="tab" onclick="showTab('expenses')">Despesas</div>
            <div class="tab" onclick="showTab('revenues')">Receitas</div>
            <div class="tab" onclick="showTab('analysis')">An√°lise Integrada</div>
        </div>

        <div id="all" class="tab-content active">
            <h2>Todas as Movimenta√ß√µes</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="allData">
                    <tr><td colspan="6" class="loading">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="expenses" class="tab-content">
            <h2>Despesas</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="expensesData">
                    <tr><td colspan="5" class="loading">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="revenues" class="tab-content">
            <h2>Receitas</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="revenuesData">
                    <tr><td colspan="5" class="loading">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="analysis" class="tab-content">
            <h2>An√°lise Integrada</h2>
            <div id="analysisContent">
                <p class="loading">Carregando an√°lise...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002/api/v1';
        let allMovements = [];
        let expensesList = [];
        let revenuesList = [];

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('pt-BR');
        }

        function showTab(tabName) {
            // Remove active de todas as tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Ativa a tab selecionada
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function loadFinancialData() {
            const token = localStorage.getItem('token') || localStorage.getItem('authToken');
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            try {
                // Carregar despesas
                const expensesResponse = await fetch(`${API_BASE}/expenses`, { headers });
                const expensesData = await expensesResponse.json();
                expensesList = expensesData.data?.items || [];
                
                // Carregar receitas
                const revenuesResponse = await fetch(`${API_BASE}/revenues`, { headers });
                const revenuesData = await revenuesResponse.json();
                revenuesList = revenuesData.data?.items || [];

                // Combinar todos os movimentos
                allMovements = [
                    ...expensesList.map(exp => ({ ...exp, type: 'EXPENSE' })),
                    ...revenuesList.map(rev => ({ ...rev, type: 'INCOME' }))
                ];

                // Atualizar resumo
                updateSummary();
                
                // Atualizar tabelas
                updateAllTable();
                updateExpensesTable();
                updateRevenuesTable();
                updateAnalysis();

                console.log('Dados carregados com sucesso:', {
                    despesas: expensesList.length,
                    receitas: revenuesList.length,
                    total: allMovements.length
                });

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.querySelectorAll('tbody').forEach(tbody => {
                    tbody.innerHTML = `<tr><td colspan="6" class="error">Erro ao carregar dados: ${error.message}</td></tr>`;
                });
            }
        }

        function updateSummary() {
            const totalExpenses = expensesList.reduce((sum, exp) => sum + exp.totalAmount, 0);
            const totalRevenues = revenuesList.reduce((sum, rev) => sum + rev.totalAmount, 0);
            const balance = totalRevenues - totalExpenses;

            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('totalRevenues').textContent = formatCurrency(totalRevenues);
            document.getElementById('balance').textContent = formatCurrency(balance);
        }

        function updateAllTable() {
            const tbody = document.getElementById('allData');
            if (allMovements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Nenhuma movimenta√ß√£o encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = allMovements.map(item => `
                <tr>
                    <td>${formatDate(item.dueDate)}</td>
                    <td class="${item.type === 'EXPENSE' ? 'expense' : 'income'}">
                        ${item.type === 'EXPENSE' ? 'Despesa' : 'Receita'}
                    </td>
                    <td>${item.description}</td>
                    <td>${item.category || 'Sem categoria'}</td>
                    <td class="${item.type === 'EXPENSE' ? 'expense' : 'income'}">
                        ${item.type === 'EXPENSE' ? '-' : '+'}${formatCurrency(item.totalAmount)}
                    </td>
                    <td>
                        <span class="status-badge ${item.isPaid || item.isReceived ? 'status-paid' : 'status-pending'}">
                            ${item.isPaid || item.isReceived ? 'Pago/Recebido' : 'Pendente'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateExpensesTable() {
            const tbody = document.getElementById('expensesData');
            if (expensesList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Nenhuma despesa encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = expensesList.map(exp => `
                <tr>
                    <td>${formatDate(exp.dueDate)}</td>
                    <td>${exp.description}</td>
                    <td>${exp.category}</td>
                    <td class="expense">-${formatCurrency(exp.totalAmount)}</td>
                    <td>
                        <span class="status-badge ${exp.isPaid ? 'status-paid' : 'status-pending'}">
                            ${exp.isPaid ? 'Pago' : 'Pendente'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateRevenuesTable() {
            const tbody = document.getElementById('revenuesData');
            if (revenuesList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Nenhuma receita encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = revenuesList.map(rev => `
                <tr>
                    <td>${formatDate(rev.dueDate)}</td>
                    <td>${rev.description}</td>
                    <td>${rev.category}</td>
                    <td class="income">+${formatCurrency(rev.totalAmount)}</td>
                    <td>
                        <span class="status-badge ${rev.isReceived ? 'status-paid' : 'status-pending'}">
                            ${rev.isReceived ? 'Recebido' : 'Pendente'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateAnalysis() {
            const totalExpenses = expensesList.reduce((sum, exp) => sum + exp.totalAmount, 0);
            const paidExpenses = expensesList.filter(exp => exp.isPaid).reduce((sum, exp) => sum + exp.totalAmount, 0);
            const pendingExpenses = totalExpenses - paidExpenses;

            const totalRevenues = revenuesList.reduce((sum, rev) => sum + rev.totalAmount, 0);
            const receivedRevenues = revenuesList.filter(rev => rev.isReceived).reduce((sum, rev) => sum + rev.totalAmount, 0);
            const pendingRevenues = totalRevenues - receivedRevenues;

            const analysisContent = document.getElementById('analysisContent');
            analysisContent.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Despesas Pagas</h3>
                        <div class="value">${formatCurrency(paidExpenses)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Despesas Pendentes</h3>
                        <div class="value">${formatCurrency(pendingExpenses)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Receitas Recebidas</h3>
                        <div class="value">${formatCurrency(receivedRevenues)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Receitas Pendentes</h3>
                        <div class="value">${formatCurrency(pendingRevenues)}</div>
                    </div>
                </div>
                <h3>An√°lise por Categoria</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Quantidade</th>
                            <th>Total</th>
                            <th>M√©dia</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${getCategoryAnalysis()}
                    </tbody>
                </table>
            `;
        }

        function getCategoryAnalysis() {
            const categories = {};
            
            expensesList.forEach(exp => {
                const cat = exp.category || 'Sem categoria';
                if (!categories[cat]) {
                    categories[cat] = { count: 0, total: 0 };
                }
                categories[cat].count++;
                categories[cat].total += exp.totalAmount;
            });

            return Object.entries(categories).map(([cat, data]) => `
                <tr>
                    <td>${cat}</td>
                    <td>${data.count}</td>
                    <td class="expense">${formatCurrency(data.total)}</td>
                    <td>${formatCurrency(data.total / data.count)}</td>
                </tr>
            `).join('');
        }

        // Carregar dados ao abrir a p√°gina
        window.addEventListener('DOMContentLoaded', loadFinancialData);
        
        // Recarregar a cada 30 segundos
        setInterval(loadFinancialData, 30000);
    </script>
</body>
</html>